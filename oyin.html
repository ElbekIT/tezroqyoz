<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß† So'z Topish O'yini - O'yin</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --danger-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--primary-gradient);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated Background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
      animation: backgroundFloat 25s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes backgroundFloat {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(-30px, -15px) rotate(120deg); }
      66% { transform: translate(15px, -30px) rotate(240deg); }
    }

    /* Loading State */
    .loading-state {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      font-size: 1.5rem;
      z-index: 1000;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Game Container */
    .game-container {
      width: 100%;
      max-width: 700px;
      position: relative;
      z-index: 1;
    }

    /* Header */
    .game-header {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 20px 30px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.3);
      object-fit: cover;
    }

    .user-details h4 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .user-details p {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .guest-info {
      background: rgba(255, 193, 7, 0.2);
      color: white;
      padding: 10px 20px;
      border-radius: 16px;
      font-size: 0.9rem;
      font-weight: 600;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    /* Game Title */
    .game-title {
      color: white;
      font-size: 3rem;
      font-weight: 900;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      letter-spacing: -0.02em;
    }

    /* Game Stats */
    .game-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      color: white;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .timer {
      background: var(--warning-gradient);
    }

    .score {
      background: var(--success-gradient);
    }

    /* Word Display */
    .word-display {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 24px;
      padding: 40px 30px;
      margin-bottom: 30px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .word-display:hover {
      transform: translateY(-5px);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
    }

    .current-word {
      font-size: 3.5rem;
      font-weight: 900;
      color: #1a202c;
      letter-spacing: 4px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      animation: wordPulse 2s ease-in-out infinite;
    }

    @keyframes wordPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .word-hint {
      color: #4a5568;
      font-size: 1.1rem;
      font-weight: 500;
    }

    /* Input Section */
    .input-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .input-label {
      color: #2d3748;
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 16px;
      text-align: center;
    }

    .word-input {
      width: 100%;
      padding: 20px 25px;
      border: 3px solid #e2e8f0;
      border-radius: 16px;
      font-size: 1.5rem;
      font-weight: 600;
      text-align: center;
      background: white;
      color: #1a202c;
      outline: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      letter-spacing: 2px;
    }

    .word-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }

    .word-input::placeholder {
      color: #a0aec0;
      font-weight: 500;
      letter-spacing: 1px;
    }

    .word-input.correct {
      border-color: #48bb78;
      background: #f0fff4;
      animation: correctPulse 0.6s ease;
    }

    .word-input.incorrect {
      border-color: #f56565;
      background: #fffafa;
      animation: incorrectShake 0.6s ease;
    }

    @keyframes correctPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @keyframes incorrectShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    /* Game Over Screen */
    .game-over {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 24px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      display: none;
      animation: slideUp 0.6s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .game-over.show {
      display: block;
    }

    .game-over-title {
      color: #1a202c;
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 20px;
    }

    .final-score {
      font-size: 4rem;
      font-weight: 900;
      background: var(--success-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 20px 0;
    }

    .game-over-message {
      color: #4a5568;
      font-size: 1.1rem;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .countdown {
      color: #718096;
      font-size: 1rem;
      font-weight: 500;
    }

    .hidden {
      display: none !important;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }

      .game-header {
        padding: 16px 20px;
        flex-direction: column;
        gap: 16px;
      }

      .game-title {
        font-size: 2rem;
      }

      .current-word {
        font-size: 2.5rem;
        letter-spacing: 2px;
      }

      .word-input {
        padding: 16px 20px;
        font-size: 1.2rem;
      }

      .game-stats {
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .stat-value {
        font-size: 1.5rem;
      }

      .final-score {
        font-size: 3rem;
      }
    }

    @media (max-width: 480px) {
      .game-title {
        font-size: 1.8rem;
      }

      .current-word {
        font-size: 2rem;
        letter-spacing: 1px;
      }

      .word-input {
        font-size: 1.1rem;
      }

      .game-stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Loading State -->
  <div class="loading-state" id="loadingState">
    <div class="loading-spinner"></div>
    <div>O'yin yuklanmoqda...</div>
  </div>

  <!-- Game Container -->
  <div class="game-container hidden" id="gameContainer">
    <!-- Game Header -->
    <div class="game-header">
      <div id="userInfoContainer">
        <!-- User info will be inserted here -->
      </div>
      
      <a href="index.html" class="back-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Bosh sahifa
      </a>
    </div>

    <!-- Game Title -->
    <h1 class="game-title">üß† So'z Topish O'yini</h1>

    <!-- Game Stats -->
    <div class="game-stats">
      <div class="stat-card timer">
        <div class="stat-label">‚è± Qolgan vaqt</div>
        <div class="stat-value" id="timer">30</div>
      </div>
      <div class="stat-card score">
        <div class="stat-label">üèÜ Ball</div>
        <div class="stat-value" id="score">0</div>
      </div>
    </div>

    <!-- Word Display -->
    <div class="word-display">
      <div class="current-word" id="currentWord">BOSHLASH</div>
      <div class="word-hint">Yuqoridagi so'zni quyidagi maydonga yozing</div>
    </div>

    <!-- Input Section -->
    <div class="input-section">
      <div class="input-label">So'zni yozing va Enter bosing:</div>
      <input 
        type="text" 
        id="wordInput" 
        class="word-input" 
        placeholder="So'zni shu yerga yozing..."
        autocomplete="off"
        autocapitalize="off"
        spellcheck="false"
      />
    </div>

    <!-- Game Over Screen -->
    <div class="game-over" id="gameOverScreen">
      <div class="game-over-title">üéâ O'yin Tugadi!</div>
      <div class="final-score" id="finalScore">0</div>
      <div class="game-over-message" id="gameOverMessage">
        Ajoyib natija! Sizning ballingiz saqlandi.
      </div>
      <div class="countdown" id="countdown">
        3 soniyadan keyin bosh sahifaga qaytasiz...
      </div>
    </div>
  </div>

  <!-- Firebase Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB1KIzGCvifH-lzNzOtY0F__AL6PU7_B_Y",
      authDomain: "elbekproductions.firebaseapp.com",
      databaseURL: "https://elbekproductions-default-rtdb.firebaseio.com",
      projectId: "elbekproductions",
      storageBucket: "elbekproductions.firebasestorage.app",
      messagingSenderId: "467619718063",
      appId: "1:467619718063:web:f370881cffbb396899c55a",
      measurementId: "G-Y46P6R2H8V"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Game Variables
    let currentUser = null;
    let isGuest = true;
    let gameTime = parseInt(localStorage.getItem("sozTime") || "30");
    let currentWord = "";
    let score = 0;
    let gameActive = false;
    let timeLeft = gameTime;

    // Word List
    const wordList = [
      "olma", "kitob", "telefon", "maktab", "uy", "daraxt", "qush", "oy", "quyosh", "bolajon",
      "suv", "non", "oila", "do'st", "sevgi", "baxt", "umid", "hayot", "vatan", "ona",
      "ota", "bola", "qiz", "o'g'il", "aka", "opa", "sinf", "ustoz", "dars", "savol",
      "javob", "daftar", "stol", "stul", "deraza", "eshik", "pol", "shift", "rang", "oq",
      "qora", "qizil", "ko'k", "yashil", "sariq", "binafsha", "pushti", "jigar", "bosh",
      "qo'l", "oyoq", "ko'z", "quloq", "burun", "og'iz", "tish", "til", "soch", "yuz"
    ];

    // DOM Elements
    const loadingState = document.getElementById('loadingState');
    const gameContainer = document.getElementById('gameContainer');
    const userInfoContainer = document.getElementById('userInfoContainer');
    const timerElement = document.getElementById('timer');
    const scoreElement = document.getElementById('score');
    const currentWordElement = document.getElementById('currentWord');
    const wordInput = document.getElementById('wordInput');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const finalScore = document.getElementById('finalScore');
    const gameOverMessage = document.getElementById('gameOverMessage');
    const countdown = document.getElementById('countdown');

    // Show game after loading
    function showGame() {
      loadingState.classList.add('hidden');
      gameContainer.classList.remove('hidden');
    }

    // Check user authentication
    function checkUserAuth() {
      // Check localStorage first for immediate feedback
      const userLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
      const userData = localStorage.getItem('userData');
      
      if (userLoggedIn && userData) {
        try {
          const user = JSON.parse(userData);
          console.log("‚úÖ User found in localStorage:", user.email);
          isGuest = false;
          currentUser = user;
          updateUserInfo();
        } catch (error) {
          console.error("‚ùå Error parsing user data:", error);
          isGuest = true;
        }
      } else {
        console.log("üë§ No user in localStorage, checking guest status");
        isGuest = localStorage.getItem("isGuest") !== "false";
      }
    }

    // Authentication
    onAuthStateChanged(auth, (user) => {
      console.log("üîÑ Auth state changed in game:", user ? user.email : "No user");
      
      if (user) {
        currentUser = {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName,
          photoURL: user.photoURL
        };
        isGuest = false;
        console.log("‚úÖ Firebase user authenticated:", user.email);
      } else {
        // Check localStorage as fallback
        checkUserAuth();
      }
      
      updateUserInfo();
      showGame();
      
      // Start game after a short delay
      setTimeout(() => {
        initGame();
      }, 500);
    });

    function updateUserInfo() {
      if (currentUser && !isGuest) {
        userInfoContainer.innerHTML = `
          <div class="user-info">
            <img class="user-avatar" src="${currentUser.photoURL || '/placeholder.svg?height=40&width=40'}" alt="User">
            <div class="user-details">
              <h4>${currentUser.displayName || 'Foydalanuvchi'}</h4>
              <p>${currentUser.email || ''}</p>
            </div>
          </div>
        `;
        console.log("‚úÖ Showing user info for:", currentUser.displayName);
      } else {
        userInfoContainer.innerHTML = `
          <div class="guest-info">
            üë§ Mehmon
          </div>
        `;
        console.log("üë§ Showing guest info");
      }
    }

    // Game Functions
    function getRandomWord() {
      return wordList[Math.floor(Math.random() * wordList.length)];
    }

    function newWord() {
      currentWord = getRandomWord();
      currentWordElement.textContent = currentWord.toUpperCase();
      wordInput.value = "";
      wordInput.className = "word-input";
    }

    function updateDisplay() {
      timerElement.textContent = timeLeft;
      scoreElement.textContent = score;
    }

    function checkAnswer() {
      const userAnswer = wordInput.value.trim().toLowerCase();
      
      if (userAnswer === currentWord.toLowerCase()) {
        score++;
        wordInput.className = "word-input correct";
        newWord();
        
        // Visual feedback
        currentWordElement.style.color = "#48bb78";
        setTimeout(() => {
          currentWordElement.style.color = "#1a202c";
        }, 300);
      } else {
        wordInput.className = "word-input incorrect";
        wordInput.value = "";
        
        // Visual feedback
        currentWordElement.style.color = "#f56565";
        setTimeout(() => {
          currentWordElement.style.color = "#1a202c";
        }, 300);
      }
      
      updateDisplay();
    }

    function endGame() {
      gameActive = false;
      wordInput.disabled = true;
      
      finalScore.textContent = score;
      
      if (currentUser && !isGuest) {
        saveScore();
        gameOverMessage.innerHTML = `
          <strong>Ajoyib natija!</strong><br>
          Sizning ballingiz saqlandi va reytingda ko'rsatiladi.<br>
          <small>Foydalanuvchi: ${currentUser.displayName || currentUser.email}</small>
        `;
        console.log("‚úÖ Saving score for user:", currentUser.displayName);
      } else {
        gameOverMessage.innerHTML = `
          <strong>Yaxshi natija!</strong><br>
          Natijangiz saqlanmadi. Natijalarni saqlash uchun 
          <a href="login.html" style="color: #667eea; font-weight: 600;">kirish</a> qiling.
        `;
        console.log("üë§ Guest game completed, score not saved");
      }
      
      gameOverScreen.classList.add('show');
      
      // Countdown
      let countdownTime = 3;
      const countdownInterval = setInterval(() => {
        countdown.textContent = `${countdownTime} soniyadan keyin bosh sahifaga qaytasiz...`;
        countdownTime--;
        
        if (countdownTime < 0) {
          clearInterval(countdownInterval);
          window.location.href = "index.html";
        }
      }, 1000);
    }

    function saveScore() {
      if (!currentUser || isGuest) {
        console.log("‚ùå Cannot save score: no user or guest mode");
        return;
      }
      
      console.log("üíæ Attempting to save score:", score, "for user:", currentUser.uid);
      
      const userRef = ref(db, "users/" + currentUser.uid);
      
      runTransaction(userRef, (currentData) => {
        const newData = {
          name: currentUser.displayName || 'Foydalanuvchi',
          email: currentUser.email,
          photoURL: currentUser.photoURL || '',
          score: score,
          lastPlayed: Date.now(),
          gamesPlayed: (currentData?.gamesPlayed || 0) + 1
        };
        
        // Only update if new score is higher
        if (!currentData || !currentData.score || score > currentData.score) {
          console.log("‚úÖ New high score! Saving:", score);
          return newData;
        } else {
          // Update games played but keep the higher score
          console.log("üìä Updating games played, keeping high score:", currentData.score);
          return {
            ...currentData,
            gamesPlayed: newData.gamesPlayed,
            lastPlayed: newData.lastPlayed
          };
        }
      }).then(() => {
        console.log("‚úÖ Score saved successfully");
      }).catch((error) => {
        console.error("‚ùå Error saving score:", error);
      });
    }

    function initGame() {
      console.log("üéÆ Initializing game...");
      console.log("üë§ User status:", isGuest ? "Guest" : "Logged in");
      console.log("‚è± Game time:", gameTime, "seconds");
      
      // Reset game state
      score = 0;
      timeLeft = gameTime;
      gameActive = true;
      
      // Setup UI
      updateDisplay();
      newWord();
      
      // Focus input
      wordInput.focus();
      wordInput.disabled = false;
      
      // Start timer
      const gameInterval = setInterval(() => {
        timeLeft--;
        updateDisplay();
        
        // Change timer color when time is running out
        if (timeLeft <= 10) {
          timerElement.style.color = "#f56565";
        }
        
        if (timeLeft <= 0) {
          clearInterval(gameInterval);
          endGame();
        }
      }, 1000);
      
      console.log("‚úÖ Game initialized successfully");
    }

    // Event Listeners
    wordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && gameActive) {
        checkAnswer();
      }
    });

    // Prevent form submission
    wordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
      }
    });

    // Initialize on page load
    checkUserAuth();

    console.log("üöÄ Game page loaded successfully");
  </script>
</body>
</html>
